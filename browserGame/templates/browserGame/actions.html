{% extends 'base.html' %}
{% load render_bundle from webpack_loader %}
{% block content %}
{% if user.is_authenticated and character %}

<form id="formAction">
    <label for="action_type">Tipo de accion:</label>
    <select name="action_type" id="action_type">
        <option value="">---</option>
        <option value="OFF">Atac</option>
        <option value="DEF">Defensa</option>
        <option value="PAS">Neutra</option>
    </select>
    <label for="action">Accion:</label>
    <select name="action" id="action_selector">
        <option value="">---</option>
        {% for action in actions %}
        {% if action.cost <= character.mana %}
        <option value="{{ action.id }}" data-hp="{{ action.health }}" data-xp="{{ action.exp }}" data-dp="{{ action.damage }}" data-ep="{{ action.exp }}" data-cost="{{ action.cost }}" data-mp="{{ action.mana }}" data-rate="{{ action.success_rate }}" class="{{ action.category }}" style="display: none;">{{ action.name }}</option>
        {% endif %}
        {% endfor %}
    </select>
    <label for="character_target">Objetivo:</label>
    <select name="character_target" id="character_target" disabled>
    <option value="">---</option>
{% for character_item in characters %}
        {% if character_item.id != character.id %}
    <option value="{{ character_item.id }}" data-hp="{{ character_item.life }}" data-lvl="{{ character_item.level }}" class="level{{ character_item.level }}">{{ character_item.nickname }} Nivel ({{ character_item.level }})</option>
    {% endif %}
{% endfor %}
</select>
{% csrf_token %}
<button onclick="enviarAccionForm()" type="button" id="submitButton" disabled>Enviar</button>
<p id="text_about_action"></p>
</form>
  <table class = "infoSeason-table">
    <thead>
      <tr>
        <th colspan="2"><h2>TEMPORADA {{ season.id }}</h2></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>NOM</td>
        <td id="nameCharacter">{{ character.nickname }}</td>
      </tr>
      <tr>
        <td>LVL</td>
        <td id="lvlCharacter">{{ character.level }}</td>
      </tr>
      <tr>
        <td>EXP</td>
        <td id="expCharacter">{{ character.exp }}</td>
      </tr>
      <tr>
        <td>MANA</td>
        <td id="manaCharacter">{{ character.mana }}</td>
      </tr>
      <tr>
        <td>VIDA</td>
        <td id="hpCharacter">{{ character.life }}</td>
      </tr>
    </tbody>
  </table>
  <script>
    var manaCharacter = character.mana
    var hpCharacter = character.life 
    var nameCharacter = character.nickname
    var lvlCharacter = character.level 
    var expCharacter = character.exp 
    $('#action_selector').val('')
    $('#action_type').val('')
    $('#character_target').val('')
    $('#character_target').prop('disabled', true);
    $('#action_type').on('change',function(){
        $('#action_selector').val('')
        $('#action_selector option').css('display','none');
        let action_type = $('#action_type').val();
        if(action_type!=""){
            $('#action_selector option.'+action_type).css('display','block');
            if(action_type != "OFF"){
                $('#character_target').prop('disabled', true);
                $('#character_target').val('')
            }else{
                $('#character_target').prop('disabled', false);
            }
            $('#submitButton').prop('disabled', true);
        }else{
            $('#character_target').prop('disabled', true);
            $('#xcharacter_target').val('')
            $('#action_selector').val('')
            $('#submitButton').prop('disabled', true);
        }
        $('#action_selector option').each(function(){
            if(parseInt(this.dataset.cost) > manaCharacter){
                console.log(manaCharacter)
                $(this).css('display','none')
            }
        });
        $('#text_about_action').text('')
    })

    var nivelPersonajeUsuario = character.level
    $('#character_target').on('change', function(){
        if($('#character_target').val() != "" && $('#action_selector').val() != ""){
            $('#submitButton').prop('disabled', false);
        }
    })
    $('#character_target option').each(function() {
    var classAttr = $(this).attr('class');
    if (classAttr) {
        var nivelPersonaje = classAttr.match(/level(\d+)/)[1];
        if(nivelPersonaje != nivelPersonajeUsuario && nivelPersonaje + 1 != nivelPersonajeUsuario && nivelPersonaje - 1 != nivelPersonajeUsuario){
            $(this).hide();
        }
    }
    });
    $('#action_selector').on('change',function(){
        let action_type = $('#action_type').val();
        if(action_type!="OFF"){
            $('#submitButton').prop('disabled', false);
        }else{
            if($('#character_target').val() != "" && $('#action_selector').val() != ""){
                $('#submitButton').prop('disabled', false);
            }
        }
        let actionSelected = $('#action_selector').val()
        let tipoAccion = $('#action_type').val()
        var hpValue = document.querySelector('#action_selector').selectedOptions[0].dataset.hp;
        var dpValue = document.querySelector('#action_selector').selectedOptions[0].dataset.dp;
        var mpValue = document.querySelector('#action_selector').selectedOptions[0].dataset.mp;
        var costValue = document.querySelector('#action_selector').selectedOptions[0].dataset.cost;
        var epValue = document.querySelector('#action_selector').selectedOptions[0].dataset.ep;
        var rateValue = document.querySelector('#action_selector ').selectedOptions[0].dataset.rate;
        if(tipoAccion == 'DEF'){
            $('#text_about_action').text("Esta acció et cura "+hpValue+" punts, costa: "+costValue+" punts de maná y té un "+rateValue+"% de probabilitats d'encertar");
        }else if(tipoAccion == 'PAS'){
            $('#text_about_action').text("Esta acció et genera "+epValue+" punts d'experiencia, i costa: "+costValue+" punts de maná y té un "+rateValue+"% de probabilitats d'encertar");
        }else if(tipoAccion == 'OFF'){
            $('#text_about_action').text("Esta acció ataca a l'oponent i li resta "+dpValue+" punts de vida, costa: "+costValue+" punts de maná y té un "+rateValue+"% de probabilitats d'encertar");
        }
        
    })
    $.ajaxSetup({
        headers: {
            'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
        }
    });

    function enviarAccionForm(){
        let idCharacter = `{{ character.id }}`;
        let idAction = $('#action_selector').val();
        let idCharacterTarget = $('#character_target').val();
        realizarAccion(idCharacter,idAction,idCharacterTarget);
    }
    function realizarAccion(idCharacter, idAction, idCharacterTarget = idCharacter){

$.ajaxSetup({
    headers: {
    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
}
});
if(idCharacterTarget==""){
    idCharacterTarget = idCharacter
}
var character = getCharacter(idCharacter);
var character_target = getCharacter(idCharacterTarget);
var action = getAction(idAction);

Promise.all([character,character_target, action]).then(function(responses) {
    var characterData = responses[0];
    var characterTargetData = responses[1];
    var actionData = responses[2];

    var expCharacter = characterData.character.exp;
    var manaCharacter = characterData.character.mana;
    var levelCharacter = characterData.character.level;
    var lifeCharacter = characterData.character.life;
    var lifeCharacterTarget = characterTargetData.character.life;
    var levelCharacterTarget = characterTargetData.character.level;

    var costValue = actionData.action.cost;
    var damage = actionData.action.damage;
    var health = actionData.action.health;
    var exp = actionData.action.exp;
    var actionType = actionData.action.category;
    var actionName = actionData.action.name;
    var actionChance = actionData.action.success_rate;

    var expCharacter = expCharacter;
    var newMana = manaCharacter - costValue;
    let randomNum = Math.floor(Math.random() * 100) + 1;
    
    let success = 0;
    var expObtained = 0;
    if(actionType == 'DEF' && lifeCharacter == levelCharacter*10){
        notificacion("info", "La teva acció: "+actionName+" no s'ha pogut realitzar perque ja tens la vida maxima.");
    }else if(costValue > manaCharacter){
        notificacion("info", "La teva acció: "+actionName+" no s'ha pogut realitzar perque no tens maná.");
    }
    else{
        if (randomNum <= actionChance) {  
            success = 1;          
            notificacion("success", "Tu accion: "+actionName+" ha tenido exito.");
            if(actionType == "OFF"){
                var expObtained = damage;
                let nivellMinim = 1;
                let nivellMaxim = 1;
                if(lifeCharacterTarget<=damage){
                    if(levelCharacter > levelCharacterTarget){
                        nivellMinim = levelCharacter;
                        nivellMaxim = levelCharacterTarget;
                    }else if(levelCharacter < levelCharacterTarget){
                        nivellMinim = levelCharacter;
                        nivellMaxim = levelCharacterTarget;
                    }else if(levelCharacter == levelCharacterTarget){
                        nivellMaxim = levelCharacter;
                        nivellMinim = levelCharacter;
                    }
                    console.log('Matas al enemigo')
                    let randomNum = Math.floor(Math.random() * (nivellMaxim - nivellMinim + 1)) + nivellMinim;
                    let expExtra = randomNum*2;
                    expObtained += expExtra;
                }
                let data = {
                    character_id: idCharacterTarget,
                    damage: damage
                };
                console.log(data)
                $.ajax({
                    url: '/damage_character/',
                    type: 'POST',
                    data: data,
                    success: function(response) {
                        console.log('La acción ha sido guardada en la base de datos (matar usuario)');
                    },
                    error: function(response){
                        console.log(response);
                    }
                });
            }else if(actionType == "DEF"){
                lifeCharacter += health;
                let limitHp = levelCharacter*10;
                if(lifeCharacter>limitHp){
                    lifeCharacter = limitHp;
                }
            }else{
                expObtained += exp;
                console.log('Realizas accion neutral');
            }
            expCharacter += expObtained;
            let limiteXp = levelCharacter*10;
            if(expCharacter > limiteXp){
                expCharacter = 0;
                levelCharacter += 1;
                console.log('Subes de nivel')
            }
            let data = {
                character_id: idCharacter,
                sendMana:newMana,
                health:lifeCharacter,
                experience:expCharacter,
                level:levelCharacter,
            };
            $.ajax({
                url: '/update_character/',
                type: 'POST',
                data: data,
                success: function(response) {
                    console.log('La acción ha sido guardada en la base de datos (actualizar usuario)');
                },
                error: function(response){
                    console.log(response);
                }
            });
        } else {
            notificacion("warning", "Tu accion: "+actionName+" no ha tenido exito.");
            success = 0;
        }
        
        let newData = {
            performer_id: idCharacter,
            target_id: idCharacterTarget,
            action_id: idAction,
            succeed: success,
        };
        $.ajax({
            url: '/save_action/',
            type: 'POST',
            data: newData,
            success: function(response) {
                console.log('La acción ha sido guardada en la base de datos');
            },
            error: function(response){
                console.log(response);
            }
        });
    }
}).catch(function(error) {
    console.log(error);
});
}
function notificacion(status, message) {
    const container = document.getElementById("notificaciones");
  
    const notification = document.createElement("div");
    notification.classList.add("notificacion", status);
    notification.textContent = message;
  
    container.appendChild(notification);
  
    setTimeout(() => {
      notification.style.opacity = 0;
      setTimeout(() => {
        notification.remove();
      }, 300);
    }, 3000);
  }
  function getCharacter(idCharacter) {
    return new Promise(function(resolve, reject) {
      $.ajax({
        url: 'api/getCharacter/'+idCharacter,
        type: 'POST',
        success: function(response) {
          console.log('El personaje se ha cogido de la base de datos');
          resolve(response);
        },
        error: function(response){
          reject(response);
        }
      });
    });
  }

function getAction(idAction) {
    return new Promise(function(resolve, reject) {
        $.ajax({
        url: 'api/getAction/'+idAction,
        type: 'POST',
        success: function(response) {
            console.log('La acción se ha cogido de la base de datos');
            resolve(response);
        },
        error: function(response){
            reject(response);
        }
        });
    });
}
</script>
{% else %}
<h1>403 Forbiden</h1>
{% endif %}
{% endblock %}